{% extends 'base.html' %}

{% block content %}

<div class="container-fluid px-5 py-2">

  <div class="row justify-content-center px-4 py-5" style="--bs-gutter-x: 2rem;">
    <!-- Left Column -->
    <div class="col-xl-9" style="flex: 0 0 72%; max-width: 72%;">
      <div class="card shadow-sm rounded-4 w-100 overflow-hidden">
        <!-- Additional Images - Profile -->
        <div class="card-body p-0">
          {% set primary_image = user.profile_images | selectattr('is_primary','equalto',True) | first %}
          {% set additional_images = user.profile_images | selectattr('is_primary','equalto',False) | list %}
          
          <div class="row g-0 position-relative w-100" style="height:400px;">
            
            <!-- Carousel Background -->
            {% if additional_images %}
            <div id="bgCarousel" class="carousel slide h-100 w-100" data-bs-ride="carousel">
              <div class="carousel-indicators">
                {% for img in additional_images %}
                <button type="button" data-bs-target="#bgCarousel" data-bs-slide-to="{{ loop.index0 }}"
                        class="{% if loop.first %}active{% endif %}" aria-current="{% if loop.first %}true{% endif %}"></button>
                {% endfor %}
              </div>
              
              <div class="carousel-inner h-100 w-100">
                {% for img in additional_images %}
                <div class="carousel-item {% if loop.first %}active{% endif %} h-100 w-100 position-relative">
                  <div class="w-100 h-100 overflow-hidden">
                    <img src="{{ img.image_url }}"
                        alt="Gallery Image"
                        class="w-100 h-100"
                        style="object-fit: cover; object-position: top;">
                  </div>

                  {% if is_own_profile %}
                  <div class="carousel-icons position-absolute top-0 end-0 m-3 d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" title="Upload New" data-bs-toggle="modal" data-bs-target="#uploadModal">
                      <i class="bi bi-camera-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteModal{{ img.id }}">
                      <i class="bi bi-trash-fill"></i>
                    </button>
                  </div>
                  {% endif %}
                </div>

                {% if is_own_profile %}
                <!-- Delete Modal -->
                <div class="modal fade" id="deleteModal{{ img.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-body text-center">
                        <p>Delete this image?</p>
                        <img src="{{ img.image_url }}" class="img-fluid mb-3" style="max-height:200px;">
                        <form method="POST" action="{{ url_for('delete_image', image_id=img.id) }}">
                          <button class="btn btn-danger">Yes, delete</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
                {% endfor %}
              </div>
            </div>

            {% else %}
            <!-- Default Carousel with Placeholder -->
            <div id="bgCarousel" class="carousel slide h-100 w-100" data-bs-ride="carousel">
              <div class="carousel-inner h-100 w-100">
                <div class="carousel-item active h-100 w-100 position-relative">
                  <img src="{{ url_for('static',filename='images/3f89f435-18a5-47d6-8823-42f51f994cef.png') }}"
                      class="w-100 h-100 object-fit-cover"
                      style="object-position: top;"
                      alt="Default Background">

                  {% if is_own_profile %}
                  <div class="carousel-icons position-absolute top-0 end-0 m-3">
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                      <i class="bi bi-pencil-fill"></i>
                    </button>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Primary Profile Image (Always Visible) -->
            <div class="position-absolute translate-middle-y" style="left:3%; bottom:-35%;">
              <div style="width:160px;height:160px;">
                {% if primary_image %}
                <img src="{{ primary_image.image_url }}" class="rounded-circle shadow"
                    style="width:100%;height:100%;object-fit:cover;border:4px solid #0a66c2">
                {% else %}
                <div class="rounded-circle shadow bg-secondary text-white d-flex justify-content-center align-items-center"
                    style="width:100%;height:100%;border:4px solid #0a66c2;font-size:2.5rem;">
                  {{ user.first_name[0] }}{{ user.last_name[0] }}
                </div>
                {% endif %}
              </div>
            </div>

          </div>
        </div>

        <!-- Profile Edit -->
        <div class="card-body py-4">
          <div class="row align-items-center">
            <div class="col-{{ 12 if not is_own_profile else 11 }}" style="font-size: 1.3rem;">
              <!-- Your content here -->
            </div>
            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Profile Info - Header -->        
        <div class="card-body">
          <div class="row align-items-center ms-2">
            <div class="col-8" style="font-size: 1.8rem; font-weight: 600;">
              {{ user.first_name }} {{ user.last_name }}
            </div>

            {% set education = user.educations[0] if user.educations else None %}
            <div class="col-4 my-2" style="font-size: 1.3rem;">
              {% if education and education.degree and education.specialization %}
                {{ education.degree }} - {{ education.specialization }}
              {% elif education and education.degree %}
                {{ education.degree }}
              {% else %}
                Education not specified
              {% endif %}
            </div>


            <div class="col-8" style="font-size: 1.3rem;">
              {% if user.profile.date_of_birth %}
                {% set dob = datetime.strptime(user.profile.date_of_birth, "%Y-%m-%d").date() %}
                {% set age = ((datetime.utcnow().date() - dob).days // 365) %}
                {{ age }} years {% if user.profile.gender %} | {{ user.profile.gender|capitalize }}{% endif %}
              {% else %}
                Date of birth not available
              {% endif %}
            </div>

            {% set address = user.addresses[0] if user.addresses else None %}
            <div class="col-8 my-2" style="font-size: 1.1rem;">
              {% if address %}
                {{ address.city.name }}, {{ address.state.name }}, {{ address.country.name }}
              {% else %}
                Address not available
              {% endif %}
            </div>

            <div class="row">
              <div class="col-sm-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Looking for</h5>
                    <p class="card-text">{{ profile.looking_for or 'Not specified' }}</p>
                    <a href="#" class="btn btn-primary">Show details</a>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Preferences</h5>
                    <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                    <a href="#" class="btn btn-primary">Set preferences</a>
                  </div>
                </div>
              </div>
            </div>

          </div>


          
        </div>
      </div>

      <!-- Profile Analytics -->        
      <div class="card shadow-sm rounded-4 w-100 overflow-hidden my-4">
        
        <!-- Analytics Info -->
        <div class="card-body py-4">
          <div class="row align-items-center ms-2">

            <div class="col-11" style="font-size: 1.7rem; font-weight: 600;">
              Analytics
            </div>

            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}

          </div>
        </div>
      
      </div>

      <!-- Profile About -->      
      <div class="card shadow-sm rounded-4 w-100 overflow-hidden my-4">
        
        <!-- About Info -->
        <div class="card-body py-4">
          <div class="row align-items-center ms-2">

            <div class="col-11" style="font-size: 1.7rem; font-weight: 600;">
              About
            </div>
            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}

          </div>
        </div>
      
      </div>

      <!-- Profile Activity -->      
      <div class="card shadow-sm rounded-4 w-100 overflow-hidden my-4">
        
        <!-- Activity Info -->
        <div class="card-body py-4">
          <div class="row align-items-center ms-2">

            <div class="col-11" style="font-size: 1.7rem; font-weight: 600;">
              Activity
            </div>
            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}

          </div>
        </div>
      
      </div>

      <!-- Profile Profession -->
      <div class="card shadow-sm rounded-4 w-100 overflow-hidden my-4">
        
        <!-- Professional Info -->
        <div class="card-body py-4">
          <div class="row align-items-center ms-2">
              
            <div class="col-11" style="font-size: 1.7rem; font-weight: 600;">
              Profession
            </div>
            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}
            {% set professional = user.professional_details[0] if user.professional_details else None %}

            <div class="row align-items-start mb-3 py-4">
              <!-- Office Building Icon -->
              <div class="col-1 d-flex justify-content-center align-items-start">
                <img src="{{ url_for('static', filename='images/office-building-icon.jpg') }}" 
                    alt="Company Icon" 
                    style="height: 60px; width: auto;" />
              </div>

              <!-- Professional Details -->
              <div class="col-11" style="font-size: 1.1rem;">
                <div class="row">
                  <!-- Company Name -->
                  <div class="col-12" style="font-size: 1.4rem; font-weight: 600;">
                    {% if professional and professional.company_name %}
                      {{ professional.company_name }}
                    {% else %}
                      Company Not Specified
                    {% endif %}
                  </div>

                  <!-- Designation, Occupation & Employment Type -->
                  <div class="col-12" style="font-size: 1.2rem;">
                    {% if professional and professional.designation %}
                      {{ professional.designation }}
                    {% endif %}

                    {% if professional and professional.occupation %}
                      {% if professional.designation %} &#8226; {% endif %}
                      {{ professional.occupation }}
                    {% endif %}

                    {% if professional and professional.employment_type %}
                      {% if professional.designation or professional.occupation %} &#8226; {% endif %}
                      {{ professional.employment_type|title }}
                    {% endif %}
                  </div>

                  <!-- Experience -->
                  <div class="col-12">
                    {% if professional and professional.years_of_experience %}
                      {{ professional.years_of_experience }} years
                    {% endif %}
                  </div>

                  <!-- Location -->
                  <div class="col-12">
                    {% if professional and professional.location %}
                      {{ professional.location }}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      
      
      
      </div>
      
      <!-- Profile Education -->
      <div class="card shadow-sm rounded-4 w-100 overflow-hidden my-4">

        <!-- Education Info -->
        <div class="card-body py-4">
          <div class="row align-items-center ms-2">

            <!-- Title -->
            <div class="col-11" style="font-size: 1.7rem; font-weight: 600;">
              Education
            </div>
            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}

            {% set education = user.educations[0] if user.educations else None %}

            <!-- Education Details Row -->
            <div class="row align-items-start mb-3 py-4">

              <!-- Book Icon -->
              <div class="col-1 d-flex justify-content-center align-items-start">
                <img src="{{ url_for('static', filename='images/education-icon.png') }}" 
                    alt="Education Icon" 
                    style="height: 60px; width: auto;" />
              </div>

              <!-- Education Details -->
              <div class="col-11" style="font-size: 1.1rem;">
                <div class="row">

                  <!-- Institute or University -->
                  <div class="col-12" style="font-size: 1.4rem; font-weight: 600;">
                    {% if education and education.institution %}
                      {{ education.institution }}
                    {% elif education and education.university %}
                      {{ education.university }}
                    {% else %}
                      Institution Not Specified
                    {% endif %}
                  </div>

                  <!-- Degree • Specialization -->
                  <div class="col-12" style="font-size: 1.2rem;">
                    {% if education and education.degree %}
                      {{ education.degree }}
                    {% endif %}
                    {% if education and education.specialization %}
                      {% if education.degree %} &#8226; {% endif %}
                      {{ education.specialization }}
                    {% endif %}
                  </div>

                  <!-- Year of Passing -->
                  <div class="col-12">
                    {% if education and education.year_of_passing %}
                      {{ education.year_of_passing }}
                    {% endif %}
                  </div>

                  <!-- Grade -->
                  <div class="col-12">
                    {% if education and education.grade %}
                      Grade: {{ education.grade }}
                    {% endif %}
                  </div>

                  <!-- City -->
                  <div class="col-12">
                    {% if education and education.city %}
                      City: {{ education.city }}
                    {% endif %}
                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="card shadow-sm rounded-4 w-100 overflow-hidden my-4">
        <!-- Language Info -->
        <div class="card-body py-4">
          <div class="row align-items-center ms-2">
            <!-- Title -->
            <div class="col-11" style="font-size: 1.7rem; font-weight: 600;">
              Languages
            </div>
            {% if is_own_profile %}
            <div class="col-1 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-pencil-fill"></i>
              </button>
            </div>
            {% endif %}
          </div>

          {% if user.languages %}
            {% for language in user.languages %}
              <div class="row align-items-start mb-3 ms-2 my-0" style="font-size: 1.1rem;">
                <div class="col-12">
                  <div class="row">
                    <!-- Language Name -->
                    <div class="col-12" style="font-size: 1.4rem; font-weight: 600;">
                      {{ language.name }}
                    </div>

                    <!-- Proficiency -->
                    <div class="col-12" style="font-size: 1.2rem;">
                      {{ language.proficiency }}
                    </div>

                  </div>
                </div>
              </div>

              {% if not loop.last %}
                <hr class="mx-3" style="margin-top: -0.5rem; margin-bottom: 0.25rem;" />
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="row align-items-start mb-3 ms-2 my-0" style="font-size: 1.1rem;"">
              <div class="col-12" style="font-size: 1.3rem; color: gray;">
                No language details added yet.
              </div>
            </div>
          {% endif %}
        </div>
      </div>


    </div>

    <!-- Right Column -->
    <div class="col-xl-3" style="flex: 0 0 27%; max-width: 27%;">
      <div class="overflow-hidden" style="position: sticky;">  <!-- Adjust offset based on your navbar height -->
      
        <div class="card shadow-sm rounded-4 overflow-hidden">
          
          <!-- Header Row -->
          <div class="card-body">
            <div class="row align-items-center px-2 mb-3">
              <div class="col-10" style="font-size: 1.4rem; font-weight: 500;">
                Birth Info &#8226; जन्म तपशील
              </div>
            {% if is_own_profile %}
            <div class="col-2 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-eye-fill"></i>
              </button>
            </div>
            {% endif %}
            </div>

            <!-- Name -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Full Name</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7" style="font-weight: 500;">
                {% if user.first_name or user.last_name %}
                  {{ (user.first_name ~ ' ' ~ user.middle_name ~ ' ' ~ user.last_name).strip() }}
                {% else %}
                  Not Available
                {% endif %}
              </div>
            </div>
            <hr class="mx-2" style="margin-top: 0.1rem; margin-bottom: 0.25rem;">
            
            <!-- Date of Birth, Age, and Gender -->
              <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Birth Date</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7" style="font-weight: 500;">
                {% if user.profile.date_of_birth %}
                  {% set dob = datetime.strptime(user.profile.date_of_birth, "%Y-%m-%d") %}
                  {{ dob.strftime("%B %d, %Y") }}
                {% else %}
                  Not Available
                {% endif %}
              </div>
            </div>
            <hr class="mx-2" style="margin-top: 0.1rem; margin-bottom: 0.25rem;">

            <!-- Birth Time -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Birth Time</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7" style="font-weight: 500;">
                {{ user.profile.birth_time or "Not Available" }}
              </div>
            </div>
            <hr class="mx-2" style="margin-top: 0.1rem; margin-bottom: 0.25rem;">
            
            <!-- Birth Place -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Birth Place</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7" style="font-weight: 500;">
                {{ user.profile.birth_city or "Not Available" }}
              </div>
            </div>
            <hr class="mx-2" style="margin-top: 0.1rem; margin-bottom: 0.25rem;">

            <!-- Gender -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Gender</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7" style="font-weight: 500;">
                {{ user.profile.gender|capitalize if user.profile.gender else "Not Available" }}
              </div>
            </div>

          </div>
        </div>

        

        <div class="card shadow-sm rounded-4 overflow-hidden my-4">
          <div class="card-body">

            <!-- Header -->
            <div class="row align-items-center px-2 mb-3">
              <div class="col-10" style="font-size: 1.4rem; font-weight: 500;">
                Janmapatrika &#8226; जन्मपत्रिका
              </div>
            {% if is_own_profile %}
            <div class="col-2 text-end">
              <button class="btn btn-sm btn-outline-secondary" title="Edit" onclick="location.href='{{ url_for('profile') }}'">
                <i class="bi bi-eye-fill"></i>
              </button>
            </div>
            {% endif %}
            </div>

            <!-- Rashi -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Rashi (राशि)</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7 fw-medium">
                {{ user.profile.rashi or "Not Available" }}
              </div>
            </div>
            <hr class="mx-2 my-1" />

            <!-- Nakshatra -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">  
              <div class="col-4">Nakshatra (नक्षत्र)</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7 fw-medium">
                {{ user.profile.nakshatra or "Not Available" }}
              </div>
            </div>
            <hr class="mx-2 my-1" />

            <!-- Lagna -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Lagna (लग्न)</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7 fw-medium">
                {{ user.profile.lagna or "Not Available" }}
              </div>
            </div>
            <hr class="mx-2 my-1" />

            <!-- Mangal Dosha -->
            <div class="row px-2 mb-2" style="font-size: 1.1rem;">
              <div class="col-4">Mangal Dosha</div>
              <div class="col-1 text-center">:</div>
              <div class="col-7 fw-medium">
                {{ user.profile.mangal_dosha or "Not Available" }}
              </div>
            </div>

          </div>
        </div>
      
        <div class="card shadow-sm rounded-4 overflow-hidden my-4">
          <!-- Profile Completion -->
          <div class="card-body">
            <div class="row px-2 mb-3">
              <div class="col-12" style="font-size: 1.4rem; font-weight: 500;">
                Profile Completion
              </div>
              <div class="col-12" style="font-size: 1.2rem; margin-top: -0.5rem;">
                  {% if profile_score < 60 %}
                    <span class="text-danger">
                      <i class="bi bi-exclamation-circle-fill me-1"></i> Incomplete
                    </span>
                  {% elif profile_score < 75 %}
                    <span class="text-warning">
                      <i class="bi bi-info-circle-fill me-1"></i> Basic Info Added
                    </span>
                  {% elif profile_score < 95 %}
                    <span class="text-primary">
                      <i class="bi bi-check-circle-fill me-1"></i> Almost Complete
                    </span>
                  {% else %}
                    <span class="text-success">
                      <i class="bi bi-check-circle-fill me-1"></i> Complete
                    </span>
                  {% endif %}
              </div>
            </div>

            <div class="d-flex flex-column justify-content-center align-items-center text-center my-2 px-2 mx-2">
              <div style="width: 120px; height: 120px; position: relative;">
                <br>
                <canvas id="profileCompletionChart" style="width: 100%; height: 100%;"></canvas>
              </div>
              <br>
              <div class="mt-2" style="font-size: 1.2rem;">
                Completed <strong class="text-success">{{ profile_score }}%</strong>
              </div>
              <br>
              
            </div>
            <hr class="mx-3 my-2" />
            <!-- Profile Completion Status Table -->
            <div class="table-responsive mt-3 px-3">
              <table class="table table-sm table mb-0">
                <thead class="text-muted">
                  <tr>
                    <th style="font-weight: 500;">Status</th>
                    <th style="font-weight: 500;">Indicator</th>
                    <th style="font-weight: 500;">Range</th>
                  </tr>
                </thead>
                <tbody class="small">
                  <tr>
                    <td class="text-danger fw-semibold">Incomplete</td>
                    <td><i class="bi bi-exclamation-circle-fill text-danger"></i></td>
                    <td>&lt; 60%</td>
                  </tr>
                  <tr>
                    <td class="text-warning fw-semibold">Basic Info</td>
                    <td><i class="bi bi-info-circle-fill text-warning"></i></td>
                    <td>60% – 74%</td>
                  </tr>
                  <tr>
                    <td class="text-primary fw-semibold">Almost Complete</td>
                    <td><i class="bi bi-check-circle-fill text-primary"></i></td>
                    <td>75% – 94%</td>        
                  </tr>
                  <tr>
                    <td class="text-success fw-semibold">Complete</td>
                    <td><i class="bi bi-check-circle-fill text-success"></i></td>
                    <td>95% – 100%</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card shadow-sm rounded-4 overflow-hidden my-4">
          <!-- Header -->
          <div class="card-body">
            <div class="row px-2 mb-3">
              <div class="col-12" style="font-size: 1.4rem; font-weight: 500;">
                Profiles looking for you
              </div>
              <div class="col-12" style="font-size: 1.2rem; margin-top: -0.5rem;">
                Recent visitors
              </div>
            </div>

            {% if viewed_by_users %}
              {% for viewed_user in viewed_by_users %}
                <div class="row align-items-stretch px-2 mb-2">

                  <!-- Profile Image -->
                  <div class="col-3 d-flex justify-content-center align-items-start pt-2">
                    {% set primary_image = viewed_user.profile_images | selectattr('is_primary') | list | first %}
                    {% if primary_image %}
                      <img src="{{ primary_image.image_url }}"
                          alt="Profile Picture"
                          class="rounded-circle img-fluid"
                          style="width: 60px; height: 60px; object-fit: cover;">
                    {% else %}
                      <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                          style="width: 60px; height: 60px; font-size: 1.1rem;">
                        {{ (viewed_user.first_name[0] ~ viewed_user.last_name[0]).upper() if viewed_user.first_name and viewed_user.last_name else 'NA' }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Profile Info -->
                  <div class="col-9 d-flex flex-column justify-content-center py-2" style="margin-left: -1rem;">

                    <!-- Full Name -->
                    <div class="fw-medium" style="font-size: 1.2rem;" onclick="location.href='{{ url_for('user_profile', username=viewed_user.username) }}'">
                      {% if viewed_user.first_name or viewed_user.last_name %}
                        {{ (viewed_user.first_name ~ ' ' ~ (viewed_user.middle_name or '') ~ ' ' ~ viewed_user.last_name).strip() }}
                      {% else %}
                        Not Available
                      {% endif %}
                    </div>

                    <!-- Age & Occupation -->
                    <div style="font-size: 1rem; margin-top: -0.2rem;">
                      {% if viewed_user.profile and viewed_user.profile.date_of_birth %}
                        {% set dob = datetime.strptime(viewed_user.profile.date_of_birth, "%Y-%m-%d").date() %}
                        {% set age = ((datetime.utcnow().date() - dob).days // 365) %}
                        {{ age }} years &#8226;
                      {% else %}
                        Age - NA &#8226;
                      {% endif %}

                      {% set professional = viewed_user.professional_details[0] if viewed_user.professional_details else None %}
                      {% if professional and professional.occupation %}
                        {{ professional.occupation }}
                      {% else %}
                        Occupation - NA
                      {% endif %}
                    </div>

                    <!-- Interest Button -->
                    <div class="mt-2">
                      <form action="view_profile.html" method="POST">
                        <button type="submit" class="btn btn-secondary rounded-5" style="font-size: 1.2rem;">
                          <i class="bi bi-person-plus me-1"></i> Interested
                        </button>
                      </form>
                    </div>
                  </div>
                </div>

                <!-- Separator Line Between Profiles -->
                {% if not loop.last %}
                  <hr class="mx-3 my-2" />
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="text-muted text-center py-3">No one has viewed your profile yet.</div>
            {% endif %}
          </div>
        </div>

        <div class="card shadow-sm rounded-4 overflow-hidden my-4">
          <!-- Header -->
          <div class="card-body">
            <div class="row px-2 mb-3">
              <div class="col-12" style="font-size: 1.4rem; font-weight: 500;">
                Profiles you might like
              </div>
              <div class="col-12" style="font-size: 1.2rem; margin-top: -0.5rem;">
                From your city
              </div>
            </div>

            {% if other_users %}
              {% for other_user in other_users %}
                <div class="row align-items-stretch px-2 mb-2">
                  
                  <!-- Profile Image -->
                  <div class="col-3 d-flex justify-content-center align-items-start pt-2">
                    {% set primary_image = other_user.profile_images | selectattr('is_primary') | list | first %}
                    {% if primary_image %}
                      <img src="{{ primary_image.image_url }}"
                          alt="Profile Picture"
                          class="rounded-circle img-fluid"
                          style="width: 60px; height: 60px; object-fit: cover;">
                    {% else %}
                      <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                          style="width: 60px; height: 60px; font-size: 1.1rem;">
                        {{ (other_user.first_name[0] ~ other_user.last_name[0]).upper() if other_user.first_name and other_user.last_name else 'NA' }}
                      </div>
                    {% endif %}
                  </div>

                  <!-- Profile Info -->
                  <div class="col-9 d-flex flex-column justify-content-center py-2" style="margin-left: -1rem;">
                    
                    <!-- Full Name -->
                    <div class="fw-medium" style="font-size: 1.2rem;" onclick="location.href='{{ url_for('user_profile', username=other_user.username) }}'") }}'">
                      {% if other_user.first_name or other_user.last_name %}
                        {{ (other_user.first_name ~ ' ' ~ (other_user.middle_name or '') ~ ' ' ~ other_user.last_name).strip() }}
                      {% else %}
                        Not Available
                      {% endif %}
                    </div>

                    <!-- Age & Occupation -->
                    <div style="font-size: 1rem; margin-top: -0.2rem;">
                      {% if other_user.profile and other_user.profile.date_of_birth %}
                        {% set dob = datetime.strptime(other_user.profile.date_of_birth, "%Y-%m-%d").date() %}
                        {% set age = ((datetime.utcnow().date() - dob).days // 365) %}
                        {{ age }} years &#8226;
                      {% else %}
                        Age - NA &#8226;
                      {% endif %}

                      {% set professional = other_user.professional_details[0] if other_user.professional_details else None %}
                      {% if professional and professional.occupation %}
                        {{ professional.occupation }}
                      {% else %}
                        Occupation - NA
                      {% endif %}
                    </div>

                    <!-- Interest Button -->
                    <div class="mt-2">
                      <form action="view_profile.html" method="POST">
                        <button type="submit" class="btn btn-secondary rounded-5" style="font-size: 1.2rem;">
                          <i class="bi bi-person-plus me-1"></i> Interested
                        </button>
                      </form>
                    </div>
                  </div>
                </div>

                <!-- Separator Line Between Profiles -->
                {% if not loop.last %}
                  <hr class="mx-3 my-2" />
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="text-muted text-center py-3">No matches found in your city yet.</div>
            {% endif %}
          </div>
        </div>

        
      </div>

    </div>



  </div>

</div>

<!-- Shared Upload Modal with Cropper -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">IJodidar Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Drag & Drop Area (toggle via JS if needed) -->
        <h5 class="fw-semibold mb-1 text-start">Additional Profile Pictures</h5>
        <p class="text-muted mb-3 text-start" style="font-size: 0.95rem;">
            Additional pictures help showcase your personality and make your profile more engaging.
        </p>

        <div id="dropArea" class="border rounded p-3 mb-3 text-muted d-none" style="border-style: dashed;">
          Drag & drop image here
        </div>

        <!-- File Input -->
        <input type="file" id="imageInput" accept="image/*" class="form-control mb-3">

        <!-- Circle Preview (used in profile page only) -->
        <div id="previewImageContainer" class="mb-3 d-flex justify-content-center d-none">
          <img id="previewImage" class="rounded-circle shadow" style="width: 128px; height: 128px; display: none;">
        </div>

        <!-- CropperJS Container -->
        <div class="d-none" id="cropContainer">
          <img id="cropImage" style="max-width: 100%;">
        </div>

        <!-- Crop Toolbar -->
        <div class="d-none my-3" id="cropToolbar">
          <button class="btn btn-sm btn-outline-primary me-2" onclick="zoomCrop(0.1)">Zoom In</button>
          <button class="btn btn-sm btn-outline-primary me-2" onclick="zoomCrop(-0.1)">Zoom Out</button>
          <button class="btn btn-sm btn-outline-danger" onclick="resetCrop()">Reset</button>
        </div>

        <!-- Upload Progress -->
        <div class="progress d-none" id="uploadProgressWrapper">
          <div class="progress-bar" id="uploadProgressBar" style="width: 0%;">0%</div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="uploadBtn" class="btn btn-success">Upload</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <!-- Success Toast -->
  <div id="uploadSuccessToast" class="toast text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-check-circle me-2"></i> Image uploaded successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>

  <!-- Failure Toast -->
  <div id="uploadFailToast" class="toast text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-x-circle me-2"></i> Upload failed. Try again.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>


<!-- External CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/upload_cropper.js') }}"></script>
<script>
  const ctx = document.getElementById('profileCompletionChart').getContext('2d');
  const profileScore = {{ profile_score|int }};  // Ensure it's a number
  const remaining = 100 - profileScore;

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Completed', 'Remaining'],
      datasets: [{
        data: [profileScore, remaining],
        backgroundColor: ['#00c851', '#ff4444'],  // Green for complete, red for incomplete
        borderWidth: 1
      }]
    },
    options: {
      cutout: '70%',  // Donut thickness
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    }
  });
</script>


{% endblock %}
