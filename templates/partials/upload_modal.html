<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<script>
let cropper;
const imageInput = document.getElementById("imageInput");
const cropContainer = document.getElementById("cropContainer");
const cropImage = document.getElementById("cropImage");
const cropToolbar = document.getElementById("cropToolbar");
const uploadBtn = document.getElementById("uploadBtn");
const uploadProgressWrapper = document.getElementById("uploadProgressWrapper");
const uploadProgressBar = document.getElementById("uploadProgressBar");

// Handle file selection
imageInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    cropImage.src = event.target.result;

    // Show crop UI
    cropContainer.classList.remove("d-none");
    cropToolbar.classList.remove("d-none");

    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1, // square crop
      viewMode: 1,
      autoCropArea: 1
    });
  };
  reader.readAsDataURL(file);
});

// Toolbar actions
function zoomCrop(val) { if (cropper) cropper.zoom(val); }
function resetCrop() { if (cropper) cropper.reset(); }
window.zoomCrop = zoomCrop;
window.resetCrop = resetCrop;

// Handle upload via AJAX
uploadBtn.addEventListener("click", async () => {
  if (!cropper) {
    alert("Please select and crop an image first.");
    return;
  }

  uploadProgressWrapper.classList.remove("d-none");
  uploadProgressBar.style.width = "0%";
  uploadProgressBar.textContent = "0%";

  cropper.getCroppedCanvas({ width: 600, height: 600 }).toBlob(async (blob) => {
    const formData = new FormData();
    formData.append("image", blob, "profile.jpg");
    formData.append("is_primary", "0"); // could toggle via checkbox in modal

    try {
      const response = await fetch("{{ url_for('upload_image') }}", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        throw new Error("Upload failed");
      }

      // Progress bar simulation (since fetch doesnâ€™t support progress)
      uploadProgressBar.style.width = "100%";
      uploadProgressBar.textContent = "Uploaded";

      // Reload to refresh carousel
      setTimeout(() => window.location.reload(), 1000);

    } catch (err) {
      console.error(err);
      alert("Upload failed!");
    }
  }, "image/jpeg");
});
</script>
